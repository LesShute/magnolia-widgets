<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Email Compose - Magnolia</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body { margin: 0; padding: 12px; background: #fff; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        h3 { margin: 0; color: #333; font-size: 14px; font-weight: 600; }
        .recipient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .recipient-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            font-size: 13px;
        }
        .recipient-item:hover { background: #e9ecef; }
        .recipient-item.disabled { opacity: 0.4; cursor: not-allowed; }
        .recipient-item input[type="checkbox"] { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; }
        .recipient-info { flex: 1; min-width: 0; }
        .recipient-role { font-weight: 600; color: #333; font-size: 12px; }
        .recipient-email { color: #666; font-size: 11px; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .no-email { color: #999; font-style: italic; }
        .btn { display: inline-block; padding: 8px 16px; font-size: 13px; font-weight: 500; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-primary:hover { background: #1565c0; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .loading { text-align: center; padding: 20px; color: #666; font-size: 13px; }
        .error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; font-size: 13px; }
        #debug { font-size: 11px; color: #666; padding: 10px; background: #f0f0f0; margin-top: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="app"><div class="loading">Loading recipients...</div></div>
    <div id="debug"></div>

    <script>
        // Config
        const EMAIL_FIELDS = [
            { field: 'Adjuster_Email', role: 'Adjuster' },
            { field: 'Email', role: 'Claimant' },
            { field: 'Physician_Email', role: 'Physician' },
            { field: 'NCM_Email', role: 'NCM' },
            { field: 'Prov_Email', role: 'Provider' },
            { field: 'Atty_Email', role: 'Attorney' }
        ];

        let recordData = null;
        let recordId = null;
        let selectedEmails = new Set();

        // Debug output
        function log(msg) {
            console.log("[SmartEmail] " + msg);
            document.getElementById('debug').innerHTML += msg + '\n';
        }

        // Start debugging immediately
        log("=== Widget Debug ===");
        log("Time: " + new Date().toLocaleTimeString());
        log("URL: " + window.location.href.substring(0, 50) + "...");
        log("In iframe: " + (window.self !== window.top));
        log("ZOHO type: " + typeof ZOHO);
        
        if (typeof ZOHO === 'undefined') {
            log("ERROR: ZOHO is undefined!");
            log("Possible causes:");
            log("  1. SDK script failed to load");
            log("  2. SDK blocked by browser");
            log("  3. Not running in Zoho context");
            
            // Check if script tag exists
            var sdkScript = document.querySelector('script[src*="zwidgets"]');
            log("SDK script tag found: " + (sdkScript ? "YES" : "NO"));
            if (sdkScript) log("SDK src: " + sdkScript.src);
        } else {
            log("ZOHO object exists!");
            log("ZOHO.embeddedApp: " + (typeof ZOHO.embeddedApp));
            
            if (typeof ZOHO.embeddedApp !== 'undefined') {
                log("Setting up PageLoad listener...");
                
                ZOHO.embeddedApp.on("PageLoad", function(data) {
                    log("PageLoad fired! Data: " + JSON.stringify(data).substring(0, 100));
                    recordId = data.EntityId || (data.Entity && data.Entity[0] && data.Entity[0].id);
                    if (recordId) {
                        loadRecordData("Potentials", recordId);
                    } else {
                        log("No recordId in PageLoad, trying getParams...");
                        tryGetParams();
                    }
                });

                log("Calling init()...");
                ZOHO.embeddedApp.init().then(function() {
                    log("init() SUCCESS!");
                }).catch(function(err) {
                    log("init() ERROR: " + err);
                });
            } else {
                log("ERROR: ZOHO.embeddedApp is undefined");
            }
        }

        function tryGetParams() {
            ZOHO.CRM.UI.Record.getParams().then(function(params) {
                log("getParams: " + JSON.stringify(params).substring(0, 100));
                if (params && params.EntityId) {
                    recordId = params.EntityId;
                    loadRecordData(params.Entity || "Potentials", recordId);
                }
            }).catch(function(err) {
                log("getParams error: " + err);
            });
        }

        function loadRecordData(entity, id) {
            log("Loading record: " + entity + "/" + id);
            ZOHO.CRM.API.getRecord({ Entity: entity, RecordID: id })
            .then(function(response) {
                log("Record loaded!");
                if (response.data && response.data.length > 0) {
                    recordData = response.data[0];
                    renderRecipients();
                } else {
                    showError("No record data returned");
                }
            }).catch(function(err) {
                log("getRecord error: " + err);
                showError("Error loading record: " + err);
            });
        }

        function renderRecipients() {
            let html = '<div class="header"><h3>Select Recipients</h3>';
            html += '<button class="btn btn-primary" id="composeBtn" onclick="openCompose()">Compose Email</button></div>';
            html += '<div class="recipient-grid">';

            EMAIL_FIELDS.forEach(function(config) {
                const email = recordData[config.field];
                const hasEmail = email && email.trim() !== '';
                if (hasEmail) selectedEmails.add(email);

                html += '<div class="recipient-item' + (hasEmail ? '' : ' disabled') + '">';
                html += '<input type="checkbox" data-email="' + (email || '') + '" ';
                html += (hasEmail ? 'checked' : 'disabled') + ' onchange="toggleEmail(this)">';
                html += '<div class="recipient-info">';
                html += '<div class="recipient-role">' + config.role + '</div>';
                html += '<div class="recipient-email">' + (hasEmail ? email : 'No email') + '</div>';
                html += '</div></div>';
            });

            html += '</div>';
            document.getElementById('app').innerHTML = html;
            updateComposeButton();
        }

        function toggleEmail(cb) {
            if (cb.checked) selectedEmails.add(cb.dataset.email);
            else selectedEmails.delete(cb.dataset.email);
            updateComposeButton();
        }

        function updateComposeButton() {
            var btn = document.getElementById('composeBtn');
            if (btn) {
                btn.disabled = selectedEmails.size === 0;
                btn.textContent = 'Compose Email' + (selectedEmails.size > 0 ? ' (' + selectedEmails.size + ')' : '');
            }
        }

        function openCompose() {
            if (selectedEmails.size === 0) return;
            var emails = Array.from(selectedEmails);
            log("Opening compose for: " + emails.join(', '));
            
            ZOHO.CRM.UI.Record.sendEmail({
                Entity: "Potentials",
                RecordID: recordId,
                To: emails
            }).catch(function(err) {
                log("sendEmail error, using mailto fallback");
                window.open('mailto:' + emails.join(','), '_blank');
            });
        }

        function showError(msg) {
            document.getElementById('app').innerHTML = '<div class="error">' + msg + '</div>';
            log("ERROR: " + msg);
        }
    </script>
</body>
</html>
